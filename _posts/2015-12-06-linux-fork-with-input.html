---
layout: post
title: Linux下通过socketpair调用其他程序并传入参数
tag: [Linux,Process]
---
<!--break-->
&nbsp;<br><pre class="brush: c; gutter: true">#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;<br>#include &lt;string.h&gt;<br><br>#include &lt;errno.h&gt;<br>#include &lt;unistd.h&gt;<br><br>#include &lt;sys/socket.h&gt;<br><br>#define ALOGV printf<br>#define ALOGD printf<br>#define ALOGE printf<br><br>typedef void(*_callback_t)(const char *);<br><br>void do_execv(char *const argv[], const char *input, _callback_t cb)<br>{<br>    int pid = -1;<br>    int sockets[2];<br><br>    socketpair( AF_UNIX, SOCK_STREAM|SOCK_CLOEXEC, 0, sockets );<br><br>    pid = fork();<br>    if( pid &gt; 0 ){<br><br>        int index = 0;<br>        char buf[1];<br>        char buffer[1024];<br><br>        close(sockets[1]);    // this descriptor is no longer needed<br><br>        if(input != NULL) {<br>            ALOGD(&quot;input=[%s]\\n\\n&quot;, input);<br>            write(sockets[0], input, strlen(input));<br>        }<br><br>        while (read(sockets[0], buf, 1) != 0)<br>        {<br>            buffer[index] = buf[0];<br>            if(buffer[index] == &#039;\\n&#039;) {<br>                buffer[index] = &#039;\\0&#039;;<br>                cb(buffer);<br>                index = 0;<br>                memset(buffer, 0, sizeof(buffer));<br>            }<br>            else {<br>                index++;<br>            }<br>        }<br><br>        cb(NULL);<br><br>        close(sockets[0]);<br>    }<br>    else if( pid == 0 ){<br><br>        close(sockets[0]);<br><br>        dup2(sockets[1], fileno(stdin));  // redirect stdin to the socketpair<br>        dup2(sockets[1], fileno(stdout));  // redirect stdout to the socketpair<br>        dup2(sockets[1], fileno(stderr));  // redirect stderr to the socketpair<br><br>        close(sockets[1]);    // this descriptor is no longer needed<br><br>        int i=0;<br>        while(argv[i] != NULL) {<br>            ALOGV(&quot;argv[%d] = %s\\n&quot;, i, argv[i]);<br>            i++;<br>        }<br><br>        execv(argv[0], argv);<br><br>        ALOGE(&quot;execv : %s for %s&quot;, strerror(errno), argv[0]);<br><br>    }<br>    else{<br>        ALOGE( &quot;fork failed\\n&quot;);<br>        close( sockets[0] );<br>        close( sockets[1] );<br>    }<br>}<br><br>void callback(const char * result)<br>{<br>    ALOGD(&quot;callback(%s)\\n&quot;, result);<br>}<br><br>int main(int argc, char *argv[])<br>{<br><br>    /* COMMENT :<br>       on my test system, the dup2(fd, 1) would fail, if no one has used the stdout. */<br><br>    ALOGD(&quot;\\n&quot;);<br><br>    char * const telnet[] = {<br>        [0] = &quot;/usr/bin/telnet&quot;,<br>        [1] = NULL<br>    };<br><br>    do_execv(telnet, &quot;?\\nq\\n&quot;, callback);<br><br>    ALOGD(&quot;\\n&quot;);<br>	<br>	while(1);<br><br>    return 0;<br>}</pre>