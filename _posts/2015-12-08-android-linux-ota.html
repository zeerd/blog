---
layout: post
title: Linux下实现增量升级（差分升级）
tag: [Android,Linux,OTA,bsdiff]
---
Android手机的差分升级功能很让人羡慕，其实调查一下就会发现，原理非常简单。<br>
<!--break-->
<br>下面我来给出一些Linux下的Shell脚本，演示一下怎么样使用bsdiff实现简单的差分升级功能。<br><br>&nbsp;<br><br>首先，需要做成差分升级包。<br><br><strong>ota_make.sh</strong><br><pre class="brush: bash; gutter: true">#!/bin/bash<br><br>newroot=<br>oldroot=<br>BSDIFF=bsdiff<br><br>function difffunc()<br>{<br>    #echo checking $1 $2 $3<br><br>    for x in $(ls -a1 $1)<br>    do<br>        if [ &quot;$x&quot; == &quot;.&quot; ] ; then<br>            ls &gt; /dev/null<br>        elif [ &quot;$x&quot; == &quot;..&quot; ] ; then<br>            ls &gt; /dev/null<br>        elif [ -d $1/$x ] ; then<br>            install -d $3/$x<br>            echo &quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;working in $1/$x&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&quot;<br>            difffunc $1/$x $2/$x $3/$x $4/$x $5/$x<br>        else<br>            #echo $1/$x.p<br>            if [ -L $2/$x ] ; then<br>                if [ -L $1/$x ] ; then<br>                    newlink=$(readlink -f $1/$x)<br>                    oldlink=$(readlink -f $2/$x)<br>                    #echo ${newlink#$newroot} vs ${oldlink#$oldroot}<br>                    if [ ${newlink#$newroot} != ${oldlink#$oldroot} ] ; then<br>                        install -d $(dirname $5/$x)<br>                        cp -P $1/$x $5/$x<br>                    fi<br>                else<br>                    install -d $(dirname $4/$x)<br>                    cp $1/$x $4/$x<br>                fi<br>            else<br>                if [ -e $2/$x ] ; then<br>                    if [ -e $1/$x ] ; then<br>                        diff $2/$x $1/$x &gt; /dev/null<br>                        if [ $? != 0 ] ; then<br>                            $BSDIFF $2/$x $1/$x $3/$x.p<br>                        fi<br>                    else<br>                        # need delete ?<br>                        ls &gt; /dev/null<br>                    fi<br>                else<br>                    install -d $(dirname $4/$x)<br>                    cp $1/$x $4/$x<br>                fi<br>            fi<br>        fi<br>    done<br>}<br><br>if [ -z $3 ] ; then<br>    echo $0 newpath oldpath patchpath<br>else<br>    install -d $3/patch<br>    install -d $3/add<br>    install -d $3/link<br><br>    if [ ${1:0:1} != &#039;/&#039; ] ; then<br>        newroot=&quot;$( cd $1; pwd )&quot;/$1<br>    else<br>        newroot=$1<br>    fi<br><br>    if [ ${2:0:1} != &#039;/&#039; ] ; then<br>        oldroot=&quot;$( cd $2; pwd )&quot;/$2<br>    else<br>        oldroot=$2<br>    fi<br><br>    echo ${newroot} vs ${oldroot}<br><br>    difffunc $1 $2 $3/patch $3/add $3/link<br>fi<br></pre><br>差分升级包做成时需要注意三种情况：<br>1、普通的文件，也就是那些需要查分的文件。实用bsdiff生成查分文件即可。<br>2、新增加的文件。bsdiff不能处理。需要独立拷贝。<br>3、link文件。需要考虑，在新的版本中，可能某些link文件指向不同的文件了。这是要对link文件进行特别的处理。<br><br>&nbsp;<br><br>&nbsp;<br><br>做成差分包之后就是如何使用差分包来升级了。<br><pre class="brush: bash; gutter: true"><br>#!/bin/bash<br><br>BSPATCH=./bsdiff-4.3/bspatch<br><br>function patchfunc()<br>{<br>    for x in $(ls -a1 $3)<br>    do<br>        if [ "$x" == "." ] ; then<br>            ls > /dev/null<br>        elif [ "$x" == ".." ] ; then<br>            ls > /dev/null<br>        elif [ -d $3/$x ] ; then<br>        	install -d $1/$x<br>            echo ">>>>>>>>working in $3/$x<<<<<<<<"<br>            patchfunc $1/$x $2/$x $3/$x<br>        else<br>        	#echo $3/$x<br>            file=${x:0:-2}<br>            rm -f $1/$file<br>        	$BSPATCH $2/$file $1/$file $3/$x<br>            chmod --reference=$2/$file $1/$file<br>        fi<br>    done<br>}<br><br>if [ -z $3 ] ; then<br>    echo $0 newpath oldpath patchpath<br>else<br>    cp -r $2 $1<br>    patchfunc $1 $2 $3/patch<br><br>    cp -r $3/add/* $1/<br>    cp -rP $3/link/* $1/<br>fi<br><br></pre><br>升级就是前面的你过程，不再多说。<br><br>最后，写个脚本用来测试。<br><br>&nbsp;<br><br>&nbsp;<br><pre class="brush: bash; gutter: true"><br>#!/bin/bash<br><br>rm -rf ota<br>install -d ota/1/d ota/2/d ota/1/s ota/2/s<br><br>ls / &gt; ota/1/s/same<br>ls / &gt; ota/2/s/same<br><br>ls /bin &gt; ota/1/d/diff<br>ls /usr/bin &gt; ota/2/d/diff<br><br>ln -s s/same ota/1/link.same<br>ln -s s/same ota/2/link.same<br><br>ln -s abc ota/1/link.diff<br>ln -s def ota/2/link.diff<br><br>ln -s s/same ota/1/link.diff2<br>ln -s d/diff ota/2/link.diff2<br><br>ln -s more1 ota/1/link.diff3<br>ln -s more1 ota/2/link.diff3<br><br>ls / &gt; ota/1/more1<br>ls / &gt; ota/2/more2<br><br>mkdir ota/1/morefolder1<br>mkdir ota/2/morefolder2<br><br>./ota_make.sh ota/2 ota/1 ota/p<br>./ota_patch.sh ota/3 ota/1 ota/p<br><br>diff -r ota/2 ota/3<br><br>tree ota<br></pre><br><br>当然，实际的差分升级过程要比这个复杂得多。比如需要进行升级前的check sum验证。等等。